version: '3.8'

services:
  mongo:
    image: mongo:6.0
    container_name: gdash-mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "${MONGO_PORT}:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - gdash-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: gdash-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_UI_PORT}:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gdash-network

  collector:
    build:
      context: ./collector
      dockerfile: Dockerfile
    container_name: gdash-collector
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      QUEUE_NAME: ${QUEUE_NAME}
      CITY_NAME: ${CITY_NAME}
      CITY_LAT: ${CITY_LAT}
      CITY_LON: ${CITY_LON}
    networks:
      - gdash-network

  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: gdash-worker
    depends_on:
      rabbitmq:
        condition: service_healthy
      backend:
        condition: service_started
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      API_URL: ${API_URL_INTERNAL}
      QUEUE_NAME: ${QUEUE_NAME}
    networks:
      - gdash-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gdash-backend
    depends_on:
      - mongo
    environment:
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@${MONGO_HOST}:${MONGO_PORT}/${MONGO_DB}?authSource=admin
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL}
      DEFAULT_ADMIN_PASS: ${DEFAULT_ADMIN_PASS}
      JWT_SECRET: ${JWT_SECRET}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      CORS_ORIGIN: ${FRONTEND_ORIGIN}
    ports:
      - "${API_PORT}:3000"
    networks:
      - gdash-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gdash-frontend
    ports:
      - "${FRONTEND_PORT}:80"
    environment:
      VITE_API_URL: ${API_URL_PUBLIC}
    depends_on:
      - backend
    networks:
      - gdash-network

volumes:
  mongo_data:

networks:
  gdash-network:
    driver: bridge
