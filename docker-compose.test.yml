version: '3.8'

services:
  mongo_test:
    image: mongo:6.0
    container_name: gdash-mongo-test
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "${MONGO_PORT}:27017"
    networks:
      - gdash-test-network

  rabbitmq_test:
    image: rabbitmq:3-management-alpine
    container_name: gdash-rabbitmq-test
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_UI_PORT}:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gdash-test-network

  collector_test:
    build:
      context: ./collector
      dockerfile: Dockerfile
    container_name: gdash-collector-test
    depends_on:
      rabbitmq_test:
        condition: service_healthy
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      QUEUE_NAME: ${QUEUE_NAME}
      CITY_NAME: ${CITY_NAME}
      CITY_LAT: ${CITY_LAT}
      CITY_LON: ${CITY_LON}
    networks:
      - gdash-test-network

  worker_test:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: gdash-worker-test
    depends_on:
      rabbitmq_test:
        condition: service_healthy
      backend_test:
        condition: service_started
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      API_URL: ${API_URL_INTERNAL}
      QUEUE_NAME: ${QUEUE_NAME}
    networks:
      - gdash-test-network

  backend_test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gdash-backend-test
    depends_on:
      - mongo_test
    environment:
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@${MONGO_HOST}:${MONGO_PORT}/${MONGO_DB}?authSource=admin
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL}
      DEFAULT_ADMIN_PASS: ${DEFAULT_ADMIN_PASS}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${FRONTEND_ORIGIN}
    ports:
      - "${API_PORT}:3000"
    networks:
      - gdash-test-network

  frontend_test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gdash-frontend-test
    ports:
      - "${FRONTEND_PORT}:80"
    environment:
      VITE_API_URL: ${API_URL_PUBLIC}
    depends_on:
      - backend_test
    networks:
      - gdash-test-network

networks:
  gdash-test-network:
    driver: bridge
